{#
    Product detail page template.
    - Displays main product image, gallery, details, and description.
    - Includes quantity controls and "Add to Cart" form.
    - Renders product recommendations ("You may also like") below main details.
    - Integrates with product_detail.js for gallery and quantity interactivity.
    - Ensure all class and ID names match those in product_detail.css and product_detail.js.
    - Recommendations section uses the same image logic as main product.
#}
{% extends 'user_Base.html' %}
{% block title %}Product Details{% endblock %}
{% block head %}
<script>
    const API_URL = "{{ api_url }}";
</script>
{{ super() }}
{% endblock %}
{% block content %}
<a href="{{ url_for('products.show_products') }}" class="btn-continue-shopping">← Continue Shopping</a>
<link rel="stylesheet" href="{{ url_for('static', filename='styles/product_detail.css') }}">
<div class="row">
    <!-- Product Image & Gallery -->
    <div class="product-detail-container">
        <div class="product-detail-left">
            {# Main product image: first image in image_gallery, fallback to image_file if gallery is empty #}
            {% set main_img = product.image_gallery[0] if product.image_gallery else product.image_file %}
            {% if main_img %}
            <img id="mainProductImg" src="{{ url_for('admin.serve_azure_image', filename=main_img) }}" class="product-detail-main-img" alt="{{ product.name }}">
            {% else %}
            <img id="mainProductImg" src="{{ url_for('static', filename='images/placeholder.png') }}" class="product-detail-main-img" alt="No image">
            {% endif %}
            <div class="product-gallery">
                {% if product.image_gallery %}
                {% for img in product.image_gallery %}
                <img src="{{ url_for('admin.serve_azure_image', filename=img) }}"
                     class="product-gallery-img"
                     alt="Gallery image"
                     data-img="{{ url_for('admin.serve_azure_image', filename=img) }}">
                {% endfor %}
                {% elif product.image_file %}
                <img src="{{ url_for('admin.serve_azure_image', filename=product.image_file) }}"
                     class="product-gallery-img"
                     alt="Gallery image"
                     data-img="{{ url_for('admin.serve_azure_image', filename=product.image_file) }}">
                {% else %}
                <img src="{{ url_for('static', filename='images/placeholder.png') }}"
                     class="product-gallery-img"
                     alt="No image"
                     data-img="{{ url_for('static', filename='images/placeholder.png') }}">
                {% endif %}
            </div>
        </div>
        <div class="product-detail-right">
            <h4 class="product-detail-title">{{ product.name }}</h4>
            <div class="product-detail-price">${{ "%.2f"|format(campus_product.price) }}</div>
            <div class="product-detail-quantity">
                In stock: {{ campus_product.campus_quantity }}
            </div>
            <form action="{{ url_for('cart.add_to_cart', campus_product_id=campus_product.id) }}" method="post" style="display:inline;">
                <div class="product-detail-qty mb-3">
                    <button type="button" id="qty-minus">-</button>
                    <input type="text" id="qty-input" name="quantity" value="1" class="product-detail-qty-input" readonly>
                    <button type="button" id="qty-plus">+</button>
                </div>
                <button class="product-detail-add-btn" type="submit">
                    <i class="fa fa-shopping-cart"></i> Add to Cart
                </button>
            </form>
            <ul class="nav nav-tabs product-detail-tabs mb-2" id="descTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab">Description</button>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active product-detail-description" id="desc" role="tabpanel">
                    <p>{{ product.description }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="may-also-like-section">
        <div class="may-also-like-title">You may also like</div>
        <div class="may-also-like-row">
            {# Render recommended products with image, name, price, and add button #}
            {% for rec in recommendations %}
            {% set rec_product = rec.product %}
            {% set rec_campus_product = rec.campus_product %}
            {% set rec_img = rec_product.image_gallery[0] if rec_product.image_gallery else rec_product.image_file %}
            <div class="product-recommend-card">
                {% if rec_img %}
                <img src="{{ url_for('admin.serve_azure_image', filename=rec_img) }}" alt="{{ rec_product.name }}">
                {% else %}
                <img src="{{ url_for('static', filename='images/placeholder.png') }}" alt="No image">
                {% endif %}
                <div class="card-title">{{ rec_product.name }}</div>
                <div class="card-text">
                    {% if rec_campus_product %}
                    ${{ "%.2f"|format(rec_campus_product.price) }}
                    {% else %}
                    Not available
                    {% endif %}
                </div>
                <button class="btn">Add</button>
            </div>

            {% endfor %}
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/product_detail.js') }}"></script>
{% endblock %}